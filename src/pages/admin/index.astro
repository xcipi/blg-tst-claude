---
import Layout from '../../layouts/Layout.astro';
import NavBar from '../../components/NavBar.astro';
import Footer from '../../components/Footer.astro';

export const prerender = false; // SSR required for auth

interface Bookmark {
  id: number;
  title: string;
  url: string;
  tags: string[];
  isPrivate: boolean;
  createdAt: string;
}

// Check authentication
const runtime = Astro.locals.runtime;
let isAuthenticated = false;
let username = '';

try {
  const cookie = Astro.request.headers.get('Cookie');
  const sessionId = cookie?.match(/session=([^;]+)/)?.[1];

  if (sessionId && runtime?.env?.DB) {
    const session = await runtime.env.DB.prepare(
      'SELECT * FROM sessions WHERE id = ? AND expires_at > datetime("now")'
    ).bind(sessionId).first();

    if (session) {
      isAuthenticated = true;
      username = session.user_id as string;
    }
  }
} catch (e) {
  console.error('Auth check error:', e);
}

// Redirect if not authenticated
if (!isAuthenticated) {
  return Astro.redirect('/login');
}

// Fetch all bookmarks (including private)
let bookmarks: Bookmark[] = [];
try {
  if (runtime?.env?.DB) {
    const result = await runtime.env.DB.prepare(
      'SELECT * FROM bookmarks ORDER BY created_at DESC'
    ).all();
    
    bookmarks = result.results.map((row: any) => ({
      id: row.id,
      title: row.title,
      url: row.url,
      tags: JSON.parse(row.tags),
      isPrivate: row.is_private === 1,
      createdAt: new Date(row.created_at).toISOString().split('T')[0]
    }));
  }
} catch (e) {
  console.error('Fetch bookmarks error:', e);
}
---

<Layout title="Admin Dashboard - sec.blog">
  <NavBar currentPath={Astro.url.pathname} />
  
  <main class="min-h-screen pt-24 pb-16 px-4">
    <div class="max-w-7xl mx-auto">
      {/* Header */}
      <div class="flex items-center justify-between mb-8">
        <div>
          <div class="text-emerald-500 font-mono text-sm mb-2">$ sudo su {username}</div>
          <h1 class="text-4xl font-bold text-white">Admin Dashboard</h1>
        </div>
        <form method="POST" action="/api/auth/logout">
          <button 
            type="submit"
            class="border border-gray-800 text-gray-400 px-4 py-2 rounded font-mono hover:border-red-500 hover:text-red-500 transition-all"
          >
            Logout
          </button>
        </form>
      </div>

      {/* Stats */}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-terminal-card border border-gray-800 rounded-lg p-6">
          <div class="text-emerald-500 text-3xl font-bold mb-2">{bookmarks.length}</div>
          <div class="text-gray-400 text-sm">Celkom bookmarkov</div>
        </div>
        <div class="bg-terminal-card border border-gray-800 rounded-lg p-6">
          <div class="text-emerald-500 text-3xl font-bold mb-2">
            {bookmarks.filter(b => !b.isPrivate).length}
          </div>
          <div class="text-gray-400 text-sm">Verejn√©</div>
        </div>
        <div class="bg-terminal-card border border-gray-800 rounded-lg p-6">
          <div class="text-emerald-500 text-3xl font-bold mb-2">
            {bookmarks.filter(b => b.isPrivate).length}
          </div>
          <div class="text-gray-400 text-sm">S√∫kromn√©</div>
        </div>
      </div>

      {/* Add Bookmark Button */}
      <div class="mb-6">
        <button
          id="add-bookmark-btn"
          class="bg-emerald-500 text-black px-6 py-3 rounded font-mono font-bold hover:bg-emerald-400 transition-all flex items-center gap-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Prida≈• bookmark
        </button>
      </div>

      {/* Bookmarks Table */}
      <div class="bg-terminal-card border border-gray-800 rounded-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-900 border-b border-gray-800">
            <tr>
              <th class="text-left px-6 py-3 text-emerald-500 font-mono text-sm">Title</th>
              <th class="text-left px-6 py-3 text-emerald-500 font-mono text-sm">URL</th>
              <th class="text-left px-6 py-3 text-emerald-500 font-mono text-sm">Tags</th>
              <th class="text-center px-6 py-3 text-emerald-500 font-mono text-sm">Privacy</th>
              <th class="text-right px-6 py-3 text-emerald-500 font-mono text-sm">Actions</th>
            </tr>
          </thead>
          <tbody>
            {bookmarks.length === 0 ? (
              <tr>
                <td colspan="5" class="px-6 py-8 text-center text-gray-400">
                  ≈Ωiadne bookmarky. Pridaj prv√Ω!
                </td>
              </tr>
            ) : (
              bookmarks.map((bookmark) => (
                <tr class="border-b border-gray-800 hover:bg-gray-900 transition-colors">
                  <td class="px-6 py-4 text-white font-semibold">{bookmark.title}</td>
                  <td class="px-6 py-4">
                    <a 
                      href={bookmark.url.startsWith('http') ? bookmark.url : `https://${bookmark.url}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-emerald-500 hover:underline text-sm font-mono"
                    >
                      {bookmark.url}
                    </a>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex flex-wrap gap-1">
                      {bookmark.tags.map(tag => (
                        <span class="text-xs text-emerald-500 font-mono">#{tag}</span>
                      ))}
                    </div>
                  </td>
                  <td class="px-6 py-4 text-center">
                    {bookmark.isPrivate ? (
                      <span class="text-red-500 text-sm">üîí Private</span>
                    ) : (
                      <span class="text-emerald-500 text-sm">üåê Public</span>
                    )}
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center justify-end gap-2">
                      <button
                        class="edit-btn text-gray-400 hover:text-emerald-500 transition-colors p-1"
                        data-id={bookmark.id}
                        data-title={bookmark.title}
                        data-url={bookmark.url}
                        data-tags={bookmark.tags.join(', ')}
                        data-private={bookmark.isPrivate}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                        </svg>
                      </button>
                      <button
                        class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-1"
                        data-id={bookmark.id}
                        data-title={bookmark.title}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <Footer />

  {/* Add/Edit Modal */}
  <div id="bookmark-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
    <div class="bg-terminal-card border border-gray-800 rounded-lg max-w-2xl w-full p-8">
      <div class="flex items-center justify-between mb-6">
        <h2 id="modal-title" class="text-2xl font-bold text-white">Prida≈• bookmark</h2>
        <button id="close-modal" class="text-gray-400 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <form id="bookmark-form" class="space-y-4">
        <input type="hidden" id="bookmark-id" />
        
        <div>
          <label class="block text-gray-400 font-mono text-sm mb-2">Title *</label>
          <input
            type="text"
            id="bookmark-title"
            required
            class="w-full bg-gray-900 border border-gray-800 rounded px-4 py-2 text-white font-mono focus:border-emerald-500 focus:outline-none"
            placeholder="N√°zov bookmarku"
          />
        </div>

        <div>
          <label class="block text-gray-400 font-mono text-sm mb-2">URL *</label>
          <input
            type="text"
            id="bookmark-url"
            required
            class="w-full bg-gray-900 border border-gray-800 rounded px-4 py-2 text-white font-mono focus:border-emerald-500 focus:outline-none"
            placeholder="example.com alebo https://example.com"
          />
        </div>

        <div>
          <label class="block text-gray-400 font-mono text-sm mb-2">Tags (oddelen√© ƒçiarkou) *</label>
          <input
            type="text"
            id="bookmark-tags"
            required
            class="w-full bg-gray-900 border border-gray-800 rounded px-4 py-2 text-white font-mono focus:border-emerald-500 focus:outline-none"
            placeholder="javascript, react, frontend"
          />
        </div>

        <div class="flex items-center gap-3">
          <input
            type="checkbox"
            id="bookmark-private"
            class="w-4 h-4 bg-gray-900 border-gray-800 rounded focus:ring-emerald-500"
          />
          <label for="bookmark-private" class="text-gray-400 font-mono text-sm">S√∫kromn√Ω bookmark üîí</label>
        </div>

        <div class="flex gap-3 pt-4">
          <button
            type="submit"
            class="bg-emerald-500 text-black px-6 py-2 rounded font-mono font-bold hover:bg-emerald-400 transition-all"
          >
            Ulo≈æi≈•
          </button>
          <button
            type="button"
            id="cancel-btn"
            class="border border-gray-800 text-gray-400 px-6 py-2 rounded font-mono hover:border-emerald-500 hover:text-emerald-500 transition-all"
          >
            Zru≈°i≈•
          </button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script>
  const modal = document.getElementById('bookmark-modal');
  const form = document.getElementById('bookmark-form') as HTMLFormElement;
  const modalTitle = document.getElementById('modal-title');
  const bookmarkId = document.getElementById('bookmark-id') as HTMLInputElement;
  const titleInput = document.getElementById('bookmark-title') as HTMLInputElement;
  const urlInput = document.getElementById('bookmark-url') as HTMLInputElement;
  const tagsInput = document.getElementById('bookmark-tags') as HTMLInputElement;
  const privateCheckbox = document.getElementById('bookmark-private') as HTMLInputElement;

  // Open modal for adding
  document.getElementById('add-bookmark-btn')?.addEventListener('click', () => {
    modalTitle!.textContent = 'Prida≈• bookmark';
    form.reset();
    bookmarkId.value = '';
    modal?.classList.remove('hidden');
  });

  // Open modal for editing
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      const title = btn.getAttribute('data-title');
      const url = btn.getAttribute('data-url');
      const tags = btn.getAttribute('data-tags');
      const isPrivate = btn.getAttribute('data-private') === 'true';

      modalTitle!.textContent = 'Upravi≈• bookmark';
      bookmarkId.value = id || '';
      titleInput.value = title || '';
      urlInput.value = url || '';
      tagsInput.value = tags || '';
      privateCheckbox.checked = isPrivate;
      modal?.classList.remove('hidden');
    });
  });

  // Close modal
  function closeModal() {
    modal?.classList.add('hidden');
    form.reset();
  }

  document.getElementById('close-modal')?.addEventListener('click', closeModal);
  document.getElementById('cancel-btn')?.addEventListener('click', closeModal);

  // Submit form
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = bookmarkId.value;
    const title = titleInput.value;
    const url = urlInput.value;
    const tags = tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
    const isPrivate = privateCheckbox.checked;

    const data = { title, url, tags, isPrivate };

    try {
      const response = await fetch(
        id ? `/api/bookmarks/${id}` : '/api/bookmarks',
        {
          method: id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }
      );

      if (response.ok) {
        window.location.reload();
      } else {
        alert('Chyba pri ukladan√≠ bookmarku');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Chyba pri ukladan√≠ bookmarku');
    }
  });

  // Delete bookmark
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      const title = btn.getAttribute('data-title');

      if (!confirm(`Naozaj chce≈° zmaza≈• "${title}"?`)) return;

      try {
        const response = await fetch(`/api/bookmarks/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert('Chyba pri mazan√≠ bookmarku');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Chyba pri mazan√≠ bookmarku');
      }
    });
  });
</script>
</Layout>
