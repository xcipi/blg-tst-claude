---
import Layout from '../../layouts/Layout.astro';
import NavBar from '../../components/NavBar.astro';
import Footer from '../../components/Footer.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Get all unique tags
const allTags = ['all', ...new Set(sortedPosts.flatMap(post => post.data.tags))];
---

<Layout title="Blog - sec.blog">
  <NavBar currentPath={Astro.url.pathname} />
  
  <main class="min-h-screen pt-24 pb-16 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="mb-8">
        <div class="text-emerald-500 font-mono text-sm mb-4">$ ls ~/blog/</div>
        <h1 class="text-4xl font-bold text-white mb-2">Články</h1>
      </div>

      <!-- Tags Filter -->
      <div class="mb-8 overflow-x-auto pb-2">
        <div class="flex gap-2 min-w-max" id="tag-filters">
          {allTags.map((tag, i) => (
            <button
              data-tag={tag}
              class={`tag-filter px-3 py-1 rounded-full text-xs font-mono border transition-all ${
                i === 0
                  ? 'bg-emerald-500 text-black border-emerald-500 font-bold active'
                  : 'bg-gray-900 text-emerald-500 border-gray-800 hover:border-emerald-500'
              }`}
            >
              {tag}
            </button>
          ))}
        </div>
      </div>

      <!-- Blog Posts Grid -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="blog-grid">
        {sortedPosts.map((post) => (
          <div class="blog-post" data-tags={post.data.tags.join(',')}>
            <BlogCard
              title={post.data.title}
              excerpt={post.data.excerpt}
              tags={post.data.tags}
              date={post.data.date}
              readTime={post.data.readTime}
              slug={post.slug}
            />
          </div>
        ))}
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  // Client-side tag filtering
  document.addEventListener('DOMContentLoaded', () => {
    const tagButtons = document.querySelectorAll('.tag-filter');
    const blogPosts = document.querySelectorAll('.blog-post');

    tagButtons.forEach(button => {
      button.addEventListener('click', () => {
        const selectedTag = button.getAttribute('data-tag');

        // Update active button
        tagButtons.forEach(btn => {
          btn.classList.remove('bg-emerald-500', 'text-black', 'border-emerald-500', 'font-bold', 'active');
          btn.classList.add('bg-gray-900', 'text-emerald-500', 'border-gray-800');
        });
        button.classList.remove('bg-gray-900', 'text-emerald-500', 'border-gray-800');
        button.classList.add('bg-emerald-500', 'text-black', 'border-emerald-500', 'font-bold', 'active');

        // Filter posts
        blogPosts.forEach(post => {
          const postTags = post.getAttribute('data-tags').split(',');
          
          if (selectedTag === 'all' || postTags.includes(selectedTag)) {
            post.style.display = 'block';
          } else {
            post.style.display = 'none';
          }
        });
      });
    });
  });
</script>
