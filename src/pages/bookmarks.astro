---
import Layout from '../layouts/Layout.astro';
import NavBar from '../components/NavBar.astro';
import Footer from '../components/Footer.astro';
import BookmarkCard from '../components/BookmarkCard.astro';

export const prerender = false; // Enable SSR for this page

interface Bookmark {
  id: number;
  title: string;
  url: string;
  tags: string[];
  date: string;
  isPrivate: boolean;
}

const runtime = Astro.locals.runtime;
let bookmarks: Bookmark[] = [];
let error: string | null = null;

// Fetch bookmarks from D1
try {
  if (runtime?.env?.DB) {
    const result = await runtime.env.DB.prepare(
      'SELECT * FROM bookmarks WHERE is_private = 0 ORDER BY created_at DESC'
    ).all();
    
    bookmarks = result.results.map((row: any) => ({
      id: row.id,
      title: row.title,
      url: row.url,
      tags: JSON.parse(row.tags),
      date: new Date(row.created_at).toISOString().split('T')[0],
      isPrivate: row.is_private === 1
    }));
  }
} catch (e) {
  error = 'Chyba pri naƒç√≠tan√≠ bookmarkov';
  console.error(e);
}

// Get all unique tags
const allTags = bookmarks.length > 0 
  ? [...new Set(bookmarks.flatMap(b => b.tags))]
  : [];
---

<Layout title="Bookmarky - sec.blog">
  <NavBar currentPath={Astro.url.pathname} />
  
  <main class="min-h-screen pt-24 pb-16 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="mb-8">
        <div class="text-emerald-500 font-mono text-sm mb-4">$ cat ~/bookmarks</div>
        <h1 class="text-4xl font-bold text-white mb-2">Bookmarky</h1>
        <p class="text-gray-400">Zauj√≠mav√© odkazy z internetu</p>
      </div>

      {error ? (
        <div class="bg-red-900/20 border border-red-500 rounded-lg p-4 text-center">
          <p class="text-red-400 font-mono">{error}</p>
          <p class="text-gray-400 text-sm mt-2">Datab√°za nie je dostupn√°. Spusti: wrangler d1 create sec-blog-db</p>
        </div>
      ) : bookmarks.length === 0 ? (
        <div class="text-center py-16">
          <p class="text-gray-400 font-mono text-lg">Zatiaƒæ ≈æiadne bookmarky.</p>
          <p class="text-gray-500 text-sm mt-2">Pridaj prv√Ω bookmark cez admin panel.</p>
        </div>
      ) : (
        <>
          {/* Filters */}
          <div class="mb-8 space-y-4">
            {/* Privacy filter */}
            <div class="flex flex-wrap gap-2">
              <button
                data-privacy="all"
                class="privacy-filter px-3 py-1 rounded-full text-xs font-mono border transition-all bg-emerald-500 text-black border-emerald-500 font-bold active"
              >
                V≈°etky
              </button>
              <button
                data-privacy="public"
                class="privacy-filter px-3 py-1 rounded-full text-xs font-mono border transition-all bg-gray-900 text-emerald-500 border-gray-800 hover:border-emerald-500"
              >
                Verejn√©
              </button>
              <button
                data-privacy="private"
                class="privacy-filter px-3 py-1 rounded-full text-xs font-mono border transition-all bg-gray-900 text-emerald-500 border-gray-800 hover:border-emerald-500"
              >
                S√∫kromn√© üîí
              </button>
            </div>

            {/* Tag filter */}
            {allTags.length > 0 && (
              <div class="overflow-x-auto pb-2">
                <div class="flex gap-2 min-w-max">
                  <button
                    data-tag="all"
                    class="tag-filter px-3 py-1 rounded-full text-xs font-mono border transition-all bg-emerald-500 text-black border-emerald-500 font-bold active"
                  >
                    all
                  </button>
                  {allTags.map(tag => (
                    <button
                      data-tag={tag}
                      class="tag-filter px-3 py-1 rounded-full text-xs font-mono border transition-all bg-gray-900 text-emerald-500 border-gray-800 hover:border-emerald-500"
                    >
                      {tag}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Bookmarks Grid */}
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" id="bookmarks-grid">
            {bookmarks.map((bookmark) => (
              <div 
                class="bookmark-item" 
                data-tags={bookmark.tags.join(',')}
                data-privacy={bookmark.isPrivate ? 'private' : 'public'}
              >
                <BookmarkCard
                  title={bookmark.title}
                  url={bookmark.url}
                  tags={bookmark.tags}
                  date={bookmark.date}
                  isPrivate={bookmark.isPrivate}
                />
              </div>
            ))}
          </div>
        </>
      )}
    </div>
  </main>

  <Footer />
</Layout>

<script>
  // Client-side bookmark filtering
  document.addEventListener('DOMContentLoaded', () => {
    const privacyButtons = document.querySelectorAll('.privacy-filter');
    const tagButtons = document.querySelectorAll('.tag-filter');
    const bookmarkItems = document.querySelectorAll('.bookmark-item');

    let activePrivacy = 'all';
    let activeTag = 'all';

    function filterBookmarks() {
      bookmarkItems.forEach(item => {
        const itemPrivacy = item.getAttribute('data-privacy');
        const itemTags = item.getAttribute('data-tags')?.split(',') || [];

        const privacyMatch = activePrivacy === 'all' || itemPrivacy === activePrivacy;
        const tagMatch = activeTag === 'all' || itemTags.includes(activeTag);

        if (privacyMatch && tagMatch) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Privacy filter
    privacyButtons.forEach(button => {
      button.addEventListener('click', () => {
        activePrivacy = button.getAttribute('data-privacy') || 'all';

        // Update active button
        privacyButtons.forEach(btn => {
          btn.classList.remove('bg-emerald-500', 'text-black', 'border-emerald-500', 'font-bold', 'active');
          btn.classList.add('bg-gray-900', 'text-emerald-500', 'border-gray-800');
        });
        button.classList.remove('bg-gray-900', 'text-emerald-500', 'border-gray-800');
        button.classList.add('bg-emerald-500', 'text-black', 'border-emerald-500', 'font-bold', 'active');

        filterBookmarks();
      });
    });

    // Tag filter
    tagButtons.forEach(button => {
      button.addEventListener('click', () => {
        activeTag = button.getAttribute('data-tag') || 'all';

        // Update active button
        tagButtons.forEach(btn => {
          btn.classList.remove('bg-emerald-500', 'text-black', 'border-emerald-500', 'font-bold', 'active');
          btn.classList.add('bg-gray-900', 'text-emerald-500', 'border-gray-800');
        });
        button.classList.remove('bg-gray-900', 'text-emerald-500', 'border-gray-800');
        button.classList.add('bg-emerald-500', 'text-black', 'border-emerald-500', 'font-bold', 'active');

        filterBookmarks();
      });
    });
  });
</script>
