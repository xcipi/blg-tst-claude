---
import Layout from '../layouts/Layout.astro';
import NavBar from '../components/NavBar.astro';
import Footer from '../components/Footer.astro';
import BookmarkCard from '../components/BookmarkCard.astro';

export const prerender = false; // Enable SSR for this page

const runtime = Astro.locals.runtime;
let bookmarks = [];
let error = null;

// Fetch bookmarks from D1
try {
  if (runtime?.env?.DB) {
    const result = await runtime.env.DB.prepare(
      'SELECT * FROM bookmarks WHERE is_private = 0 ORDER BY created_at DESC'
    ).all();
    
    bookmarks = result.results.map((row: any) => ({
      id: row.id,
      title: row.title,
      url: row.url,
      tags: JSON.parse(row.tags),
      date: new Date(row.created_at).toISOString().split('T')[0],
      isPrivate: row.is_private === 1
    }));
  }
} catch (e) {
  error = 'Chyba pri načítaní bookmarkov';
  console.error(e);
}
---

<Layout title="Bookmarky - sec.blog">
  <NavBar currentPath={Astro.url.pathname} />
  
  <main class="min-h-screen pt-24 pb-16 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="mb-8">
        <div class="text-emerald-500 font-mono text-sm mb-4">$ cat ~/bookmarks</div>
        <h1 class="text-4xl font-bold text-white mb-2">Bookmarky</h1>
        <p class="text-gray-400">Zaujímavé odkazy z internetu</p>
      </div>

      {error ? (
        <div class="bg-red-900/20 border border-red-500 rounded-lg p-4 text-center">
          <p class="text-red-400 font-mono">{error}</p>
          <p class="text-gray-400 text-sm mt-2">Databáza nie je dostupná. Spusti: wrangler d1 create sec-blog-db</p>
        </div>
      ) : bookmarks.length === 0 ? (
        <div class="text-center py-16">
          <p class="text-gray-400 font-mono text-lg">Zatiaľ žiadne bookmarky.</p>
          <p class="text-gray-500 text-sm mt-2">Pridaj prvý bookmark cez admin panel.</p>
        </div>
      ) : (
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {bookmarks.map((bookmark: any) => (
            <BookmarkCard
              title={bookmark.title}
              url={bookmark.url}
              tags={bookmark.tags}
              date={bookmark.date}
              isPrivate={bookmark.isPrivate}
            />
          ))}
        </div>
      )}
    </div>
  </main>

  <Footer />
</Layout>
